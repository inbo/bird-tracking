---
title: "Prepare Movebank data for GBIF IPT upload (make Darwin Core)"
author:
- Peter Desmet
- Sanne Govaert
date: "`r Sys.Date()`"
output:
  html_document
---

This script prepares Movebank bird tracking data for upload to a [GBIF IPT](https://gbif.org/ipt). It is designed for datasets deposited on Zenodo.

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

Load libraries:

```{r}
library(magrittr)
library(here)
library(movepub) # devtools::install_github("inbo/movepub")
library(EML)
library(jsonlite)
library(stringr)
```

## Set user-defined values

```{r}
project_id <- "O_WESTERSCHELDE"
versioned_doi <- "https://doi.org/10.5281/zenodo.5879096"
rights_holder <- "INBO"
contact <- person(
  given = "Peter",
  family = "Desmet",
  email = "peter.desmet@inbo.be",
  comment = c(ORCID = "0000-0002-8442-8025")
)
```

Create file paths:

```{r}
dir <- here::here("data", "processed", project_id, "dwc")
record_id <- gsub("https://doi.org/10.5281/zenodo.", "", versioned_doi)
zenodo_url <- paste0("https://zenodo.org/records/", record_id, "/export/json")
datapackage_url <- paste0("https://zenodo.org/records/", record_id, "/files/datapackage.json")
```

## Create and write EML

```{r}
eml <- movepub::write_eml(
  doi = versioned_doi,
  directory = dir,
  contact = contact,
  derived_paragraph = TRUE
)
```

Process EML:

```{r}
# Get description from Zenodo
# - Has HTML, see https://github.com/inbo/movepub/issues/65)
# - Doesn't include NOTES/CHANGELOG to description
zenodo <- jsonlite::read_json(zenodo_url)
description_full <- zenodo$metadata$description
```

```{r}
# Split description in paragraphs + convert to docbook
paragraphs <- html_to_docbook(description_full)

# Keep desired paragraphs
# 1: overview of the study
paragraph_1 <- str_subset(paragraphs, paste(project_id, "-"))[1]

# 2: Reference to paper
paragraph_2 <- str_subset(paragraphs, "for a more detailed description of this dataset")[1]

# 3: Acknowledgements
paragraph_3 <- str_subset(paragraphs, "This dataset was collected|These data were collected")[1]

# 4: derived paragraph from write_eml()
derived_paragraph <- tail(eml$dataset$abstract$para, 1)

# Combine and update EML
eml$dataset$abstract$para <-
  c(paragraph_1, paragraph_2, paragraph_3, derived_paragraph)
```

Test if EML is valid:

```{r}
EML::eml_validate(eml)
```

Write EML (again):

```{r}
EML::write_eml(eml, file = file.path(dir, "eml.xml"))
```

## Create and write Darwin Core

Read package:

```{r}
package <- movepub::read_package(datapackage_url)
```

Write files:

```{r}
movepub::write_dwc(
  package = package,
  directory = dir,
  dataset_id = package$id,
  dataset_name = eml$dataset$title,
  license = toupper(eml$dataset$intellectualRights$para),
  rights_holder = rights_holder
)
```
