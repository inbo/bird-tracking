---
title: "Prepare CR-Birding (meta)data for Movebank upload"
author: "Sanne Govaert, Peter Desmet"
date: "`r Sys.Date()`"
output:
  html_document
---

This script prepares [CR-Birding](https://submit.cr-birding.org/) bird ringing data for upload to [Movebank](https://www.movebank.org/). For a project, it downloads **reference and observation data** from a the CR-Birding Submit website and transforms these to the [Movebank data format](https://www.movebank.org/node/2381) using `dplyr::mutate()` (see below).

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

Load libraries:

```{r}
library(tidyverse)
library(here)
```

Set user-defined values:

```{r}
project_id <- "LARGE_GULLS"
start_date <- "1980-01-01"
end_date <- "2024-12-31"
```

## Get observation data from CR-Birding

Load custom function to create download URLs:

```{r}
source(here::here("src", "functions", "download_urls.R"))
```

Create URLs by year:

```{r}
urls <- download_urls(start_date, end_date, project_id)
```

Unfortunately, these URLs require a browser login and cannot be queried via R. I wrote them to file:

```{r eval = FALSE}
readr::write_lines(urls, here::here("cr-birding-urls.csv"))
```

Then downloaded each manually and concatenated all files in the command line with `awk` (cf. UvA-BiTS):

```
awk 'FNR > 1' crbirding_export_*.csv > crbirding_export_nh.csv
```

After which the header needs to be added with:

```
cat crbirding_export_headers.csv crbirding_export_nh.csv > crbirding_export.csv
```

## Process data

Read the raw data:

```{r eval = FALSE}
raw_data <- readr::read_csv(
  here::here("data", "raw", project_id, "crbirding_export.csv.gz"),
  col_types = cols(.default = col_character())
)
```

Process data:

```{r}
data <-
  raw_data |>
  
  # Convert types
  dplyr::mutate(
    observation_lat = as.numeric(observation_lat),
    observation_lon = as.numeric(observation_lon),
    observation_date = lubridate::ymd(observation_date),
    observation_time = dplyr::if_else(is.na(observation_time), "00:00:00", observation_time),
    observation_is_capture = dplyr::if_else(observation_is_capture == "Y", TRUE, FALSE)
  ) |>
  
  # Add columns
  dplyr::mutate(
    observation_datetime = as.POSIXct(paste(observation_date, observation_time), tz = "UTC"),
    dead = stringr::str_detect(observation_condition, "dead"),
    revalidation_release = dplyr::if_else(observation_condition == "released after revalidation", TRUE, FALSE),
    bird_code_clean = stringr::str_remove(
      stringr::str_remove(bird_code, stringr::fixed("B-")), stringr::fixed(".")
    )
  ) |>
  
  # Exclude unwanted data
  dplyr::filter(
    !is.na(bird_id) &
    status != "impossible" &
    stringr::str_sub(bird_code_clean, 3, 3) != "B" # Dummy rings
  ) |>
  
  # Sort by bird_id, datetime and capture (important for mutate(.by) later)
  dplyr::arrange(bird_id, observation_datetime, dplyr::desc(observation_is_capture)) |>
  
  # Add row number per group
  dplyr::mutate(row_number = dplyr::row_number(), .by = bird_id) |>
  
  # Add observation type
  dplyr::mutate(
    observation_type = case_when(
      # Capture before release
      observation_is_capture & lead(revalidation_release)
        ~ "capture",
      # Release after capture
      revalidation_release & lag(observation_is_capture)
        ~ "release",
      # Single release (and therefore capture)
      revalidation_release
        ~ "capture+release",
      # Single capture (and therefore release)
      observation_is_capture & !lead(revalidation_release) &
      (!lag(observation_is_capture) | is.na(lag(observation_is_capture)))
        ~ "capture+release",
      # Dead
      dead & (!lag(dead) | is.na(lag(dead)))
        ~ "dead"
    ),
    .by = bird_id
  ) |>
  
  # Remove columns that should not be used for mapping
  dplyr::select(
    -observation_reference,
    -observation_date,
    -observation_time,
    -observation_location,
    -animal_project,
    -bird_species_euring,
    -bird_ring_description,
    -observation_is_certain,
    -observation_notes,
    -user_id,
    -user_name,
    -`sex (appearance)`,
    -`reading direction`,
    -`sex (copulation/courtship)`
  ) |>
  
  # Order columns
  dplyr::select(
    bird_id,
    bird_code,
    bird_reference,
    bird_species,
    bird_sex,
    bird_age_ringing,
    observation_type,
    observation_is_capture,
    revalidation_release,
    dead,
    observation_id,
    row_number,
    observation_datetime,
    observation_lat,
    observation_lon,
    observation_region_euring,
    observation_condition,
    `status full-grown bird`,
    inserted,
    status,
    status_reason
  )
```

Save to CSV:

```{r}
readr::write_csv(data, file = here::here("data", "interim", project_id, "observation_data.csv"), na = "")
```

## Create reference data (metadata)

For a project, get data on animals, rings and deployments in the [Movebank reference data format](https://www.movebank.org/node/27).

Map data:

```{r get_ref_data}
movebank_ref_data <-
  data
```

Save to CSV:

```{r}
readr::write_csv(movebank_ref_data, file = here::here("data", "processed", project_id, "movebank_ref_data.csv"), na = "")
```

## Get location data (observations)

Map data:

```{r get_ref_data}
movebank_location_data <-
  data
```

Save to CSV:

```{r}
readr::write_csv(movebank_location_data, file = here::here("data", "processed", project_id, "movebank_location_data.csv"), na = "")
```
